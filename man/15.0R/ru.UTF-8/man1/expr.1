.\" -*- nroff -*-
.\"-
.\" Copyright (c) 1993 Winning Strategies, Inc.
.\" All rights reserved.
.\"
.\" Redistribution and use in source and binary forms, with or without
.\" modification, are permitted provided that the following conditions
.\" are met:
.\" 1. Redistributions of source code must retain the above copyright
.\"    notice, this list of conditions and the following disclaimer.
.\" 2. Redistributions in binary form must reproduce the above copyright
.\"    notice, this list of conditions and the following disclaimer in the
.\"    documentation and/or other materials provided with the distribution.
.\" 3. All advertising materials mentioning features or use of this software
.\"    must display the following acknowledgement:
.\"      This product includes software developed by Winning Strategies, Inc.
.\" 4. The name of the author may not be used to endorse or promote products
.\"    derived from this software without specific prior written permission
.\"
.\" THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
.\" IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
.\" OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
.\" IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
.\" INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
.\" NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
.\" DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
.\" THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
.\" (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
.\" THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
.\"
.\" FRDP path ./bin/expr/expr.1
.\" FRDP githash fa9896e082a1046ff4fbc75fcba4d18d1f2efc19
.\" FRDP hash256 6eca168d13a41de329f7c911533c7c91fb35bd7b89d4b0be4647258afde1c993
.Dd 5 октября 2016
.Dt EXPR 1
.Os
.Sh ИМЯ
.Nm expr
.Nd вычисляет выражение
.Sh СИНТАКСИС
.Nm
.Op Fl e
.Ar выражение
.Sh ОПИСАНИЕ
Утилита
.Nm
вычисляет
.Ar выражение
и записывает результат в стандартный вывод.
.Pp
Все операторы и операнды должны передаваться как отдельные аргументы.
Некоторые операторы имеют специальное значение для командных интерпретаторов
и поэтому должны быть соответствующим образом экранированы.
Все целочисленные операнды интерпретируются по основанию 10 и должны состоять только из
необязательного ведущего знака минус, за которым следует одна или более цифр (если
не включён менее строгий разбор для обратной совместимости с
предыдущими версиями
.Nm
в
.Fx ) .
.Pp
Арифметические операции выполняются с использованием знаковой целочисленной математики
в диапазоне, соответствующем типу данных C
.Vt intmax_t
(максимальный доступный знаковый целочисленный тип).
Все преобразования и операции проверяются на переполнение.
Переполнение приводит к завершению программы с выводом сообщения об ошибке в stdout
и с ошибочным статусом.
.Pp
Опция
.Fl e
включает поведение обратной совместимости, подробно описанное ниже.
.Pp
Операторы перечислены ниже в порядке возрастания приоритета; все
они левоассоциативны.
Операторы с равным приоритетом сгруппированы в пределах символов
.Ql {
и
.Ql } .
.Bl -tag -width indent
.It Ar выражение1 Li \&| Ar выражение2
Возвращает вычисление
.Ar выражения1 ,
если оно не является пустой строкой или нулём;
в противном случае возвращает вычисление
.Ar выражения2 ,
если оно не является пустой строкой;
в противном случае возвращает ноль.
.It Ar выражение1 Li & Ar выражение2
Возвращает вычисление
.Ar выражения1 ,
если ни одно выражение не вычисляется в пустую строку или ноль;
в противном случае возвращает ноль.
.It Ar выражение1 Bro =, >, >=, <, <=, != Brc Ar выражение2
Возвращает результат целочисленного сравнения, если оба аргумента целочисленные;
в противном случае возвращает результат строкового сравнения с использованием локале-специфичной
последовательности сортировки.
Результат каждого сравнения равен 1, если указанное отношение истинно,
или 0, если отношение ложно.
.It Ar выражение1 Bro +, - Brc Ar выражение2
Возвращает результат сложения или вычитания целочисленных аргументов.
.It Ar выражение1 Bro *, /, % Brc Ar выражение2
Возвращает результат умножения, целочисленного деления или остатка от деления целочисленных аргументов.
.It Ar выражение1 Li \&: Ar выражение2
Оператор
.Dq Li \&:
сопоставляет
.Ar выражение1
с
.Ar выражение2 ,
которое должно быть базовым регулярным выражением.
Регулярное выражение привязывается
к началу строки с неявным
.Dq Li ^ .
.Pp
Если сопоставление успешно и шаблон содержит хотя бы одно подвыражение регулярного
выражения,
возвращается строка, соответствующая
.Dq Li \e1 ;
в противном случае оператор сопоставления возвращает количество совпавших символов.
Если сопоставление неудачно и шаблон содержит подвыражение регулярного выражения,
возвращается пустая строка;
в противном случае 0.
.El
.Pp
Скобки используются для группировки обычным образом.
.Pp
Утилита
.Nm
не делает лексического различия между аргументами, которые могут быть
операторами, и аргументами, которые могут быть операндами.
Операнд, лексически идентичный оператору, будет считаться
синтаксической ошибкой.
См. примеры ниже для обходного пути.
.Pp
Синтаксис команды
.Nm
в целом исторически сложился и неудобен.
Новым приложениям рекомендуется использовать арифметику оболочки вместо
.Nm .
.Ss Совместимость с предыдущими реализациями
Если совместимость с
.Fx
4.x
не включена, эта версия
.Nm
соответствует
.Tn POSIX
Utility Syntax Guidelines, которые требуют, чтобы ведущий аргумент, начинающийся
с знака минус, рассматривался как опция программы.
Стандартный синтаксис
.Fl Fl
может быть использован для предотвращения такой интерпретации.
Однако многие исторические реализации
.Nm ,
включая реализацию в предыдущих версиях
.Fx ,
не допускают такой синтаксис.
См. примеры ниже для переносимых способов гарантировать корректную
интерпретацию.
Функция
.Xr check_utility_compat 3
(с аргументом
.Fa utility
равным
.Dq Li expr )
используется для определения, должен ли быть включён режим обратной совместимости.
Эта возможность предназначена для использования в качестве переходного и отладочного средства, когда
.Nm
используется в сложных скриптах, которые не могут быть легко переписаны, чтобы избежать
непереносимого использования.
Включение режима обратной совместимости также неявно включает опцию
.Fl e ,
поскольку это соответствует историческому поведению
.Nm
в
.Fx . Эта опция делает разбор чисел менее строгим и разрешает ведущие
пробельные символы и необязательный ведущий знак плюс.
Кроме того, пустые операнды
имеют подразумеваемое значение ноль в числовом контексте.
По историческим причинам, определение переменной окружения
.Ev EXPR_COMPAT
также включает режим обратной совместимости.
.Sh ОКРУЖЕНИЕ
.It Ev EXPR_COMPAT
Если установлена, включает режим обратной совместимости.
.El
.Sh СТАТУС ВЫХОДА
Утилита
.Nm
завершается со следующими значениями:
.Bl -tag -width indent -compact
.It 0
выражение не является ни пустой строкой, ни 0.
.It 1
выражение является пустой строкой или 0.
.It 2
выражение недопустимо.
.El
.Sh ПРИМЕРЫ
.Bl -bullet
.It
Следующий пример (в синтаксисе
.Xr sh 1 )
добавляет единицу к переменной
.Va a :
.It
Это не сработает, если значение
.Va a
отрицательное число.
Чтобы защитить отрицательные значения
.Va a
от интерпретации в качестве опций команды
.Nm ,
можно переставить выражение:
.It
В более общем случае, заключайте возможно отрицательные значения в скобки:
.It
С арифметикой оболочки экранирование не требуется:
.It
Этот пример печатает часть имени файла из пути, хранящегося
в переменной
.Va a .
Поскольку
.Va a
может представлять путь
.Pa / ,
необходимо предотвратить его интерпретацию как оператор деления.
Символы
.Li //
разрешают эту неоднозначность.
.It
В современном синтаксисе
.Xr sh 1 ,
раскрывается в то же значение.
.El
.Pp
Следующие примеры выводят количество символов в переменной
.Va a .
Опять же, если
.Va a
может начинаться с дефиса, необходимо предотвратить его интерпретацию
как опцию для
.Nm ,
и
.Va a
может быть интерпретирован как оператор.
.Bl -bullet
.It
Чтобы справиться со всем этим, требуется сложная команда
:
.It
В современном синтаксисе
.Xr sh 1 ,
это можно сделать гораздо проще:
раскрывается в требуемое число.
.El
.Sh СМ. ТАКЖЕ
.Xr sh 1 ,
.Xr test 1 ,
.Xr check_utility_compat 3
.Sh СТАНДАРТЫ
Утилита
.Nm
соответствует
.St -p1003.1-2008 ,
при условии, что режим обратной совместимости не включён.
.Pp
Режим обратной совместимости выполняет менее строгие проверки числовых аргументов:
.Bl -bullet
.It
Пустая строка операнда интерпретируется как 0.
.El
.Bl -bullet
.It
Ведущие пробельные символы и/или знак плюс перед иначе корректным положительным
числовым операндом разрешены и будут игнорироваться.
.El
.Pp
Расширенный арифметический диапазон и проверки переполнения не конфликтуют с
требованием POSIX выполнять арифметику с использованием знаковых long, поскольку
они влияют на результат только в тех случаях, когда использование знаковых
long привело бы к неопределённому поведению.
.Pp
Согласно стандарту
.Tn POSIX ,
использование строковых аргументов
.Va length ,
.Va substr ,
.Va index ,
или
.Va match
даёт неопределённые результаты.
В этой версии
.Nm ,
эти аргументы трактуются просто как их соответствующие строковые значения.
.Pp
Флаг
.Fl e
является расширением.
.Sh ИСТОРИЯ
Утилита
.Nm
впервые появилась в Programmer's Workbench (PWB/UNIX).
Публичная версия
.Nm
написанная
.An Pace Willisson Aq Mt pace@blitz.com
появилась в
.Bx 386 0.1 .
.Sh АВТОРЫ
Первоначальная реализация
.An Pace Willisson Aq Mt pace@blitz.com
была в значительной степени переписана
.An -nosplit
.An J.T. Conklin Aq Mt jtc@FreeBSD.org .
