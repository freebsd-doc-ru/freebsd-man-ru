.\" FRDP path ./cddl/contrib/opensolaris/cmd/lockstat/lockstat.1
.\" FRDP githash f53355131f65d64e7643d734dbcd4fb2a5de20ed
.\" FRDP hash256 52fcfa198006e8406fb6c932fdc39c0cd776c3bedb135f695237c0e9412f780c
.Dd 25 февраля, 2020
.Dt LOCKSTAT 1
.Os
.Sh ИМЯ
.Nm lockstat
.Nd отчёт по статистике блокировок и профилирования ядра
.Sh СИНТАКСИС
.Nm
.Op Fl ACEHIV
.Op Fl e Ar список-событий
.Op Fl i Ar частота
.Op Fl b | t | h | s Ar глубина
.Op Fl n Ar количество-записей
.Op Fl l Ar блокировка Oo Ns , Ns Ar размер Oc
.Op Fl d Ar длительность
.Op Fl f Ar функция Oo Ns , Ns Ar размер Oc
.Op Fl T
.Op Fl kgwWRpP
.Op Fl D Ar количество
.Op Fl o имя_файла
.Op Fl x Ar опция Oo Ns = Ns Ar значение Oc
.Ar команда
.Op Oo Ar аргументы Oc
.Sh ОПИСАНИЕ
Утилита
.Nm
собирает и отображает статистику блокировок и профилирования ядра.
.Nm
позволяет указать, какие события отслеживать (например, вращение адаптивного
мьютекса, блокировка на чтение rwlock из-за ожидающих писателей и т.д.), какой
объём данных собирать для каждого события и как отображать данные.
По умолчанию,
.Nm
наблюдает за всеми событиями состязания за блокировки, собирает данные о частоте
и времени этих событий и отображает данные в порядке убывания частоты, так что
наиболее частые события появляются первыми.
.Pp
.Nm
собирает данные до завершения указанной команды.
Например, чтобы собрать статистику за фиксированный интервал времени, используйте
.Xr sleep 1
в качестве команды, как показано ниже:
.Pp
.Dl # lockstat sleep 5
.Pp
При указании опции
.Fl I ,
.Nm lockstat
устанавливает для каждого процессора источник периодических прерываний высокого
уровня для сбора данных профилирования.
Обработчик прерывания просто генерирует событие
.Nm ,
вызываемое прерванным PC (счётчиком команд).
Событие профилирования подобно любому другому событию
.Nm lockstat ,
поэтому все обычные опции
.Nm lockstat
применимы.
.Pp
.Nm
полагается на DTrace для модификации текста выполняемого ядра с целью перехвата
интересующих событий.
Это налагает небольшие, но измеримые накладные расходы на всю активность системы,
поэтому доступ к
.Nm
по умолчанию ограничен суперпользователем.
.Sh OPTIONS
Поддерживаются следующие опции:
.Bl -tag -width indent
.It Fl V
Вывести программу на D, используемую для сбора запрошенных данных.
.El
.Ss Event Selection
Если опции выбора событий не указаны, по умолчанию используется
.Fl C .
.Bl -tag -width indent
.It Fl A
Наблюдать за всеми событиями блокировок.
.Fl A
эквивалентно
.Fl CH .
.It Fl C
Наблюдать за событиями состязания.
.It Fl E
Наблюдать за событиями ошибок.
.It Fl e Ar список-событий
Наблюдать только за указанными событиями.
.Ar список-событий
представляет собой разделённый запятыми список событий или диапазонов событий,
например, 1,4-7,35.
Запустите
.Nm
без аргументов, чтобы получить краткое описание всех событий.
.It Fl H
Наблюдать за событиями удержания.
.It Fl I
Наблюдать за событиями прерываний профилирования.
.It Fl i Ar частота
Частота прерываний (в секунду) для
.Fl I .
По умолчанию 97 Гц, чтобы профилирование не шло в ногу с прерываниями часов
(которые работают на 100 Гц).
.El
.Ss Data Gathering
.Bl -tag -width indent
.It Fl x Ar аргумент Oo Ns = Ns Ar значение Oc
Включить или изменить опцию времени выполнения
.Xr dtrace 1
или опцию компилятора D.
Логические опции включаются указанием их имени.
Опции со значениями устанавливаются разделением имени опции и значения знаком
равенства.
.El
.Bl -tag -width indent
.It Fl b
Основная статистика: блокировка, вызывающий, количество событий.
.It Fl h
Гистограмма: время плюс гистограммы распределения времени.
.It Fl s Ar глубина
Трассировка стека: гистограмма плюс трассировки стека глубиной до
.Ar глубина
кадров.
.It Fl t
Время: основная плюс время для всех событий (по умолчанию).
.El
.Bl -tag -width indent
.It Fl d Ar длительность
Наблюдать только за событиями длиннее
.Ar длительность .
.It Fl f Ar функция Ns Oo Ns , Ns Ar размер Oc Ns
Наблюдать только за событиями, сгенерированными
.Ar функцией ,
которая может быть указана как символьное имя или шестнадцатеричный адрес.
.Ar размер
по умолчанию равен размеру символа ELF, если доступен, или 1, если нет.
.It Fl l Ar блокировка Ns Oo Ns , Ns Ar размер Oc Ns
Наблюдать только за
.Ar блокировкой ,
которая может быть указана как символьное имя или шестнадцатеричный адрес.
.Ar размер
по умолчанию равен размеру символа ELF или 1, если размер символа недоступен.
.It Fl n Ar количество-записей
Максимальное количество записей данных.
.It Fl T
Трассировать (а не семплировать) события.
По умолчанию выключено.
.El
.Ss Data Reporting
.Bl -tag -width indent
.It Fl D Ar количество
Отображать только первые
.Ar количество
событий каждого типа.
.It Fl g
Показывать общее количество событий, сгенерированных функцией.
Например, если
.Fn foo
вызывает
.Fn bar
в цикле, работа, выполненная
.Fn bar ,
считается работой, сгенерированной
.Fn foo
(наряду с любой работой, выполненной самой
.Fn foo ).
Опция
.Fl g
работает путём подсчёта общего количества стековых кадров, в которых появляется
каждая функция.
Это подразумевает два следствия: (1) данные, отображаемые с помощью
.Fl g ,
могут вводить в заблуждение, если трассировки стека недостаточно глубоки, и (2)
функции, вызываемые рекурсивно, могут показывать активность более 100%.
В свете проблемы (1) режим сбора данных по умолчанию при использовании
.Fl g
это
.Fl s 50 .
.It Fl k
Объединять PC внутри функций.
.It Fl o Ar имя_файла
Направлять вывод в
.Ar имя_файла .
.It Fl P
Сортировать данные по произведению (\fIколичество * время\fR).
.It Fl p
Вывод в разбираемом формате.
.It Fl R
Отображать частоты (событий в секунду) вместо количеств.
.It Fl W
Безразлично: различать события только по вызывающему, а не по блокировке.
.It Fl w
Где угодно: различать события только по блокировке, а не по вызывающему.
.El
.Sh DISPLAY FORMATS
Следующие заголовки появляются над различными столбцами данных.
.Bl -tag -width indent
.It Count или ops/s
Количество возникновений данного события или частота (раз в секунду), если
указана опция
.Fl R .
.It indv
Процент от всех событий, представленных данным отдельным событием.
.It genr
Процент от всех событий, сгенерированных данной функцией.
.It cuml
Накопительный процент; текущая сумма индивидов.
.It rcnt
Среднее количество ссылок.
Для эксклюзивных блокировок (мьютексы, спин-блокировки, rwlock, удерживаемые как
писатель) это всегда будет 1, но для разделяемых блокировок (rwlock, удерживаемые
как читатель) может быть больше 1.
.It nsec
Средняя длительность событий в наносекундах, в зависимости от события.
Для события профилирования длительность означает задержку прерывания.
.It Lock
Адрес блокировки; отображается символически, если возможно.
.It CPU+Pri_Class
CPU плюс класс приоритета прерванного потока.
Например, если CPU 4 прерывается во время выполнения потока с разделением времени,
это будет отображено как
.Ql cpu[4]+TShar .
.It Caller
Адрес вызывающего; отображается символически, если возможно.
.El
.Sh ПРИМЕРЫ
.Bl -tag -width 0n
.It Пример 1: Измерение состязания за блокировки ядра
.Pp
.Li # lockstat sleep 5
.Bd -literal
Вращение адаптивного мьютекса: 41411 событий за 5.011 секунд (8263 событий/сек)

Кол-во indv cuml rcnt     нсек Lock                   Caller
-------------------------------------------------------------------------------
13750  33%  33% 0.00       72 vm_page_queue_free_mtx vm_page_free_toq+0x12e
13648  33%  66% 0.00       66 vm_page_queue_free_mtx vm_page_alloc+0x138
 4023  10%  76% 0.00       51 vm_dom+0x80            vm_page_dequeue+0x68
 2672   6%  82% 0.00      186 vm_dom+0x80            vm_page_enqueue+0x63
  618   1%  84% 0.00       31 0xfffff8000cd83a88     qsyncvp+0x37
  506   1%  85% 0.00      164 0xfffff8000cb3f098     vputx+0x5a
  477   1%  86% 0.00       69 0xfffff8000c7eb180     uma_dbg_getslab+0x5b
  288   1%  87% 0.00       77 0xfffff8000cd8b000     vn_finished_write+0x29
  263   1%  88% 0.00      103 0xfffff8000cbad448     vinactive+0xdc
  259   1%  88% 0.00       53 0xfffff8000cd8b000     vfs_ref+0x24
  237   1%  89% 0.00       20 0xfffff8000cbad448     vfs_hash_get+0xcc
  233   1%  89% 0.00       22 0xfffff8000bfd9480     uma_dbg_getslab+0x5b
  223   1%  90% 0.00       20 0xfffff8000cb3f098     cache_lookup+0x561
  193   0%  90% 0.00       16 0xfffff8000cb40ba8     vref+0x27
  175   0%  91% 0.00       34 0xfffff8000cbad448     vputx+0x5a
  169   0%  91% 0.00       51 0xfffff8000cd8b000     vfs_unbusy+0x27
  164   0%  92% 0.00       31 0xfffff8000cb40ba8     vputx+0x5a
[...]

Блокировка адаптивного мьютекса: 10 событий за 5.011 секунд (2 события/сек)

Кол-во indv cuml rcnt     нсек Lock                   Caller
-------------------------------------------------------------------------------
    3  30%  30% 0.00    17592 vm_page_queue_free_mtx vm_page_alloc+0x138
    2  20%  50% 0.00    20528 vm_dom+0x80            vm_page_enqueue+0x63
    2  20%  70% 0.00    55502 0xfffff8000cb40ba8     vputx+0x5a
    1  10%  80% 0.00    12007 vm_page_queue_free_mtx vm_page_free_toq+0x12e
    1  10%  90% 0.00     9125 0xfffff8000cbad448     vfs_hash_get+0xcc
    1  10% 100% 0.00     7864 0xfffff8000cd83a88     qsyncvp+0x37
-------------------------------------------------------------------------------
[...]
.Ed
.It Пример 2: Измерение времени удержания
.Pp
.Li # lockstat -H -D 10 sleep 1
.Bd -literal
Удержание адаптивного мьютекса: 109589 событий за 1.039 секунд (105526 событий/сек)

Кол-во indv cuml rcnt     нсек Lock                   Caller
-------------------------------------------------------------------------------
 8998   8%   8% 0.00      617 0xfffff8000c7eb180     uma_dbg_getslab+0xd4
 5901   5%  14% 0.00      917 vm_page_queue_free_mtx vm_object_terminate+0x16a
 5040   5%  18% 0.00      902 vm_dom+0x80            vm_page_free_toq+0x88
 4884   4%  23% 0.00     1056 vm_page_queue_free_mtx vm_page_alloc+0x44e
 4664   4%  27% 0.00      759 vm_dom+0x80            vm_fault_hold+0x1a13
 4011   4%  31% 0.00      888 vm_dom                 vm_page_advise+0x11b
 4010   4%  34% 0.00      957 vm_dom+0x80            _vm_page_deactivate+0x5c
 3743   3%  38% 0.00      582 0xfffff8000cf04838     pmap_is_prefaultable+0x158
 2254   2%  40% 0.00      952 vm_dom                 vm_page_free_toq+0x88
 1639   1%  41% 0.00      591 0xfffff800d60065b8     trap_pfault+0x1f7
-------------------------------------------------------------------------------
[...]

Удержание писателем R/W: 64314 событий за 1.039 секунд (61929 событий/сек)

Кол-во indv cuml rcnt     нсек Lock                   Caller
-------------------------------------------------------------------------------
 7421  12%  12% 0.00     2994 pvh_global_lock        pmap_page_is_mapped+0xb6
 4668   7%  19% 0.00     3313 pvh_global_lock        pmap_enter+0x9ae
 1639   3%  21% 0.00      733 0xfffff80168d10200     vm_object_deallocate+0x683
 1639   3%  24% 0.00     3061 0xfffff80168d10200     unlock_and_deallocate+0x2b
 1639   3%  26% 0.00     2966 0xfffff80168d10200     vm_fault_hold+0x16ee
 1567   2%  29% 0.00      733 0xfffff80168d10200     vm_fault_hold+0x19bc
  821   1%  30% 0.00      786 0xfffff801eb0cc000     vm_object_madvise+0x32d
  649   1%  31% 0.00     4918 0xfffff80191105300     vm_fault_hold+0x16ee
  648   1%  32% 0.00     8112 0xfffff80191105300     unlock_and_deallocate+0x2b
  647   1%  33% 0.00     1261 0xfffff80191105300     vm_object_deallocate+0x683
-------------------------------------------------------------------------------
.Ed
.It Пример 3: Измерение времени удержания для трассировок стека, содержащих определённую функцию
.Pp
.Li # lockstat -H -f tcp_input -s 50 -D 10 sleep 1
.Bd -literal
Удержание адаптивного мьютекса: 68 событий за 1.026 секунд (66 событий/сек)

-------------------------------------------------------------------------------
Кол-во indv cuml rcnt     нсек Lock                   Caller
   32  47%  47% 0.00     1631 0xfffff800686f50d8     tcp_do_segment+0x284b

      нсек ------ Распределение времени ------ кол-во     Стек
      1024 |@@@@@@@@@@                     11        tcp_input+0xf54
      2048 |@@@@@@@@@@@@@                  14        ip_input+0xc8
      4096 |@@@@@                          6         swi_net+0x192
      8192 |                               1         intr_event_execute_handlers+0x93
                                                     ithread_loop+0xa6
                                                     fork_exit+0x84
                                                     0xffffffff808cf9ee
-------------------------------------------------------------------------------
Кол-во indv cuml rcnt     нсек Lock                   Caller
   29  43%  90% 0.00     4851 0xfffff800686f50d8     sowakeup+0xf8

      нсек ------ Распределение времени ------ кол-во     Стек
      4096 |@@@@@@@@@@@@@@@                15        tcp_do_segment+0x2423
      8192 |@@@@@@@@@@@@                   12        tcp_input+0xf54
     16384 |@@                             2         ip_input+0xc8
                                                     swi_net+0x192
                                                     intr_event_execute_handlers+0x93
                                                     ithread_loop+0xa6
                                                     fork_exit+0x84
                                                     0xffffffff808cf9ee
-------------------------------------------------------------------------------
[...]
.Ed
.El
.Sh СМ. ТАКЖЕ
.Xr dtrace 1 ,
.Xr ksyms 4 ,
.Xr locking 9
.Sh ИСТОРИЯ
Утилита
.Nm
впервые появилась в
.Fx 7.1 .
.Sh NOTES
Исключение хвостовой рекурсии может влиять на места вызовов.
Например, если
.Fn foo Ns +0x50
вызывает
.Fn bar ,
и последнее, что делает
.Fn bar ,
это вызов
.Fn mtx_unlock ,
компилятор может организовать, чтобы
.Fn bar
переходил в
.Fn mtx_unlock
с адресом возврата
.Fn foo Ns +0x58.
Таким образом, вызов
.Fn mtx_unlock
в
.Fn bar
будет выглядеть так, как если бы он произошёл по адресу
.Fn foo Ns +0x58.
.Pp
PC в стековом кадре, в котором происходит прерывание, может быть неверным,
потому что между вызовами функций компилятор вправе использовать регистр адреса
возврата для локального хранения.
.Pp
При совместном использовании опций
.Fl I
и
.Fl s
прерванный PC обычно не будет появляться в стеке, поскольку обработчик прерывания
вызывается асинхронно, а не вызовом функции из этого PC.
