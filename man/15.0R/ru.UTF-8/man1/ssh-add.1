.\"	$OpenBSD: ssh-add.1,v 1.87 2024/06/17 08:30:29 djm Exp $
.\"
.\" Author: Tatu Ylonen <ylo@cs.hut.fi>
.\" Copyright (c) 1995 Tatu Ylonen <ylo@cs.hut.fi>, Espoo, Finland
.\"                    All rights reserved
.\"
.\" As far as I am concerned, the code I have written for this software
.\" can be used freely for any purpose.  Any derived versions of this
.\" software must be clearly marked as such, and if the derived work is
.\" incompatible with the protocol description in the RFC file, it must be
.\" called by a name other than "ssh" or "Secure Shell".
.\"
.\"
.\" Copyright (c) 1999,2000 Markus Friedl.  All rights reserved.
.\" Copyright (c) 1999 Aaron Campbell.  All rights reserved.
.\" Copyright (c) 1999 Theo de Raadt.  All rights reserved.
.\"
.\" Redistribution and use in source and binary forms, with or without
.\" modification, are permitted provided that the following conditions
.\" are met:
.\" 1. Redistributions of source code must retain the above copyright
.\"    notice, this list of conditions and the following disclaimer.
.\" 2. Redistributions in binary form must reproduce the above copyright
.\"    notice, this list of conditions and the following disclaimer in the
.\"    documentation and/or other materials provided with the distribution.
.\"
.\" THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
.\" IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
.\" OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
.\" IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
.\" INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
.\" NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
.\" DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
.\" THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
.\" (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
.\" THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
.\"
.\" FRDP path ./crypto/openssh/ssh-add.1
.\" FRDP githash 0fdf8fae8b569bf9fff3b5171e669dcd7cf9c79e
.\" FRDP hash256 927e902f9aa85368f1eb3e4fe07fb9233dd8cf13e63bf0cee430733c54634efb
.Dd 17 июня 2024
.Dt SSH-ADD 1
.Os
.Sh ИМЯ
.Nm ssh-add
.Nd добавляет закрытые ключи в агент аутентификации OpenSSH
.Sh СИНТАКСИС
.Nm ssh-add
.Op Fl CcDdKkLlqvXx
.Op Fl E Ar fingerprint_hash
.Op Fl H Ar hostkey_file
.Op Fl h Ar destination_constraint
.Op Fl S Ar provider
.Op Fl t Ar life
.Op Ar
.Nm ssh-add
.Fl s Ar pkcs11
.Op Fl Cv
.Op Ar certificate ...
.Nm ssh-add
.Fl e Ar pkcs11
.Nm ssh-add
.Fl T
.Ar pubkey ...
.Sh ОПИСАНИЕ
.Nm
добавляет закрытые ключи в агент аутентификации
.Xr ssh-agent 1 .
При запуске без аргументов добавляет файлы
.Pa ~/.ssh/id_rsa ,
.Pa ~/.ssh/id_ecdsa ,
.Pa ~/.ssh/id_ecdsa_sk ,
.Pa ~/.ssh/id_ed25519
и
.Pa ~/.ssh/id_ed25519_sk .
После загрузки закрытого ключа
.Nm
попытается загрузить соответствующую информацию о сертификате из
имени файла, полученного путём добавления
.Pa -cert.pub
к имени файла закрытого ключа.
Альтернативные имена файлов могут быть указаны в командной строке.
.Pp
Если для какого-либо файла требуется парольная фраза,
.Nm
запрашивает её у пользователя.
Парольная фраза считывается с tty пользователя.
.Nm
повторяет последнюю парольную фразу, если указано несколько файлов идентификации.
.Pp
Для работы
.Nm
агент аутентификации должен быть запущен, а переменная окружения
.Ev SSH_AUTH_SOCK
должна содержать имя его сокета.
.Pp
Параметры следующие:
.Bl -tag -width Ds
.It Fl C
При загрузке ключей в агент или удалении ключей из агента обрабатывать
только сертификаты и пропускать обычные ключи.
.It Fl c
Указывает, что добавленные идентификаторы должны подтверждаться перед
использованием для аутентификации.
Подтверждение выполняется с помощью
.Xr ssh-askpass 1 .
Успешное подтверждение сигнализируется нулевым статусом выхода из
.Xr ssh-askpass 1 ,
а не текстом, введённым в запросе.
.It Fl D
Удаляет все идентификаторы из агента.
.It Fl d
Вместо добавления идентификаторов удаляет идентификаторы из агента.
Если
.Nm
был запущен без аргументов, будут удалены ключи для идентификаторов по умолчанию и
их соответствующие сертификаты.
В противном случае список аргументов будет интерпретирован как список путей к
файлам открытых ключей для указания ключей и сертификатов, которые необходимо удалить из агента.
Если по указанному пути открытый ключ не найден,
.Nm
добавит
.Pa .pub
и повторит попытку.
Если список аргументов состоит из
.Dq - ,
то
.Nm
будет считывать открытые ключи для удаления из стандартного ввода.
.It Fl E Ar fingerprint_hash
Задаёт алгоритм хеширования, используемый при отображении отпечатков ключей.
Допустимые варианты:
.Dq md5
и
.Dq sha256 .
По умолчанию используется
.Dq sha256 .
.It Fl e Ar pkcs11
Удаляет ключи, предоставленные общей библиотекой PKCS#11
.Ar pkcs11 .
.It Fl H Ar hostkey_file
Задаёт файл known_hosts для поиска hostkey при использовании
ключей с ограничением по назначению через флаг
.Fl h .
Этот параметр может быть указан несколько раз для поиска в нескольких файлах.
Если файлы не указаны,
.Nm
будет использовать файлы known_hosts по умолчанию из
.Xr ssh_config 5 :
.Pa ~/.ssh/known_hosts ,
.Pa ~/.ssh/known_hosts2 ,
.Pa /etc/ssh/ssh_known_hosts ,
и
.Pa /etc/ssh/ssh_known_hosts2 .
.It Fl h Ar destination_constraint
При добавлении ключей ограничивает их использование только определёнными хостами или
конкретными назначениями.
.Pp
Ограничения назначения вида
.Sq [user@]dest-hostname
разрешают использование ключа только с исходного хоста (на котором запущен
.Xr ssh-agent 1 )
на указанный хост назначения, с необязательным именем пользователя.
.Pp
Ограничения вида
.Sq src-hostname>[user@]dst-hostname
позволяют использовать ключ, доступный в переадресованном
.Xr ssh-agent 1 ,
через определённый хост (указанный как
.Sq src-hostname )
для аутентификации на другой хост,
указанный как
.Sq dst-hostname .
.Pp
При загрузке ключей может быть добавлено несколько ограничений назначения.
При попытке аутентификации с ключом, имеющим ограничения назначения,
весь путь подключения, включая
переадресацию
.Xr ssh-agent 1 ,
проверяется на соответствие этим ограничениям, и каждый
переход должен быть разрешён для успешной попытки.
Например, если ключ переадресован на удалённый хост
.Sq host-b
и пытается пройти аутентификацию на другой хост
.Sq host-c ,
то операция будет успешной только если
переход с исходного хоста на
.Sq host-b
был разрешён, а последующий переход
.Sq host-b>host-c
также разрешён ограничениями назначения.
.Pp
Хосты идентифицируются по их hostkey и ищутся
.Nm
в файлах known_hosts.
Для имён хостов могут использоваться шаблоны с подстановочными знаками, а также
поддерживаются сертификаты hostkey.
По умолчанию ключи, добавляемые с помощью
.Nm ,
не ограничены по назначению.
.Pp
Ограничения назначения были добавлены в выпуске OpenSSH 8.9.
Поддержка как в удалённом SSH-клиенте, так и на сервере требуется при использовании
ключей с ограничением по назначению через переадресованный канал
.Xr ssh-agent 1 .
.Pp
Также важно отметить, что ограничения назначения могут быть
принудительно применены
.Xr ssh-agent 1
только при использовании ключа или при его переадресации
.Sy сотрудничающим
.Xr ssh 1 .
В частности, это не мешает злоумышленнику с доступом к удалённому
.Ev SSH_AUTH_SOCK
снова переадресовать его и использовать на другом хосте (но только для
разрешённого назначения).
.It Fl K
Загружает резидентные ключи из FIDO-аутентификатора.
.It Fl k
При загрузке ключей в агент или удалении ключей из агента обрабатывать только обычные закрытые
ключи и пропускать сертификаты.
.It Fl L
Выводит параметры открытых ключей всех идентификаторов, которые в данный момент представлены
агентом.
.It Fl l
Выводит отпечатки всех идентификаторов, которые в данный момент представлены агентом.
.It Fl q
Тихий режим после успешной операции.
.It Fl S Ar provider
Задаёт путь к библиотеке, которая будет использоваться при добавлении
ключей, размещённых на FIDO-аутентификаторе, переопределяя стандартное использование
встроенной поддержки USB HID.
.It Fl s Ar pkcs11
Добавляет ключи, предоставленные общей библиотекой PKCS#11
.Ar pkcs11 .
Файлы сертификатов могут быть дополнительно указаны в качестве аргументов командной строки.
Если они присутствуют, то будут загружены в агент с использованием любых
соответствующих закрытых ключей, загруженных из токена PKCS#11.
.It Fl T Ar pubkey ...
Проверяет, пригодны ли закрытые ключи, соответствующие указанным
файлам
.Ar pubkey ,
для использования, выполняя операции подписи и проверки для каждого.
.It Fl t Ar life
Устанавливает максимальное время жизни при добавлении идентификаторов в агент.
Время жизни может быть указано в секундах или в формате времени,
описанном в
.Xr sshd_config 5 .
.It Fl v
Подробный режим.
Приводит к тому, что
.Nm
выводит отладочные сообщения о ходе выполнения.
Это полезно при отладке проблем.
Несколько параметров
.Fl v
увеличивают уровень детализации.
Максимум — 3.
.It Fl X
Разблокирует агент.
.It Fl x
Блокирует агент с помощью пароля.
.El
.Sh ОКРУЖЕНИЕ
.Bl -tag -width Ds
Если
.Nm
требуется парольная фраза, она будет считана с текущего
терминала, если программа была запущена из терминала.
Если
.Nm
не связана с терминалом, но установлены
.Ev DISPLAY
и
.Ev SSH_ASKPASS ,
она выполнит программу, указанную в
.Ev SSH_ASKPASS
(по умолчанию
.Dq ssh-askpass ),
и откроет окно X11 для считывания парольной фразы.
Это особенно полезно при вызове
.Nm
из скрипта
.Pa .xsession
или аналогичного.
.Pp
.Ev SSH_ASKPASS_REQUIRE
позволяет дополнительно контролировать использование программы askpass.
Если эта переменная установлена в
.Dq never ,
то
.Nm
никогда не будет пытаться её использовать.
Если установлено значение
.Dq prefer ,
то
.Nm
будет предпочитать использовать программу askpass вместо TTY при запросе
паролей.
Наконец, если переменная установлена в
.Dq force ,
то программа askpass будет использоваться для всего ввода парольных фраз независимо от того,
установлен ли
.Ev DISPLAY .
.It Ev SSH_AUTH_SOCK
Определяет путь к сокету домена
.Ux Ns ,
используемому для связи с агентом.
.It Ev SSH_SK_PROVIDER
Задаёт путь к библиотеке, которая будет использоваться при загрузке любых
ключей, размещённых на FIDO-аутентификаторе, переопределяя стандартное использование
встроенной поддержки USB HID.
.El
.Sh ФАЙЛЫ
.Bl -tag -width Ds -compact
.It Pa ~/.ssh/id_ecdsa
.It Pa ~/.ssh/id_ecdsa_sk
.It Pa ~/.ssh/id_ed25519
.It Pa ~/.ssh/id_ed25519_sk
.It Pa ~/.ssh/id_rsa
Содержат идентификатор аутентификации пользователя ECDSA, ECDSA на аутентификаторе, Ed25519,
Ed25519 на аутентификаторе или RSA.
.El
.Pp
Файлы идентификации не должны быть читаемы кем-либо, кроме пользователя.
Обратите внимание, что
.Nm
игнорирует файлы идентификации, если они доступны другим.
.Sh СТАТУС ВЫХОДА
Статус выхода равен 0 при успехе, 1 при неудаче указанной команды
и 2, если
.Nm
не может связаться с агентом аутентификации.
.Sh СМ. ТАКЖЕ
.Xr ssh 1 ,
.Xr ssh-agent 1 ,
.Xr ssh-askpass 1 ,
.Xr ssh-keygen 1 ,
.Xr sshd 8
.Sh АВТОРЫ
OpenSSH является производным от оригинального и свободного
релиза ssh 1.2.12 от Tatu Ylonen.
Aaron Campbell, Bob Beck, Markus Friedl, Niels Provos,
Theo de Raadt и Dug Song
исправили множество ошибок, повторно добавили новые функции и
создали OpenSSH.
Markus Friedl внёс вклад в поддержку версий протокола SSH
1.5 и 2.0.
