.\"
.\" Copyright (c) 1994 University of Maryland
.\" All Rights Reserved.
.\"
.\" Permission to use, copy, modify, distribute, and sell this software and its
.\" documentation for any purpose is hereby granted without fee, provided that
.\" the above copyright notice appear in all copies and that both that
.\" copyright notice and this permission notice appear in supporting
.\" documentation, and that the name of U.M. not be used in advertising or
.\" publicity pertaining to distribution of the software without specific,
.\" written prior permission.  U.M. makes no representations about the
.\" suitability of this software for any purpose.  It is provided "as is"
.\" without express or implied warranty.
.\"
.\" U.M. DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE, INCLUDING ALL
.\" IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO EVENT SHALL U.M.
.\" BE LIABLE FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
.\" WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
.\" ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR
.\" IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
.\"
.\" Author: James da Silva, Systems Design and Analysis Group
.\"			   Computer Science Department
.\"			   University of Maryland at College Park
.\"
.\" FRDP path ./usr.sbin/crunch/crunchgen/crunchgen.1
.\" FRDP githash b2c76c41be32f904179efed29c0ca04d53f3996c
.\" FRDP hash256 de58b7e38460c479d8b52d9ab4ca69b58a185a9fe285db243a88339f96382970
.Dd 6 января 2017
.Dt CRUNCHGEN 1
.Os
.Sh ИМЯ
.Nm crunchgen
.Nd генерирует окружение сборки для объединённого двоичного файла
.Sh СИНТАКСИС
.Bk -words
.Nm
.Op Fl foql
.Op Fl h Ar имя-заголовка-makefile
.Op Fl m Ar имя-makefile
.Op Fl p Ar префикс-объектов
.Op Fl c Ar имя-c-файла
.Op Fl e Ar имя-исполняемого-файла
.Ar файл-конфигурации
.Ek
.Sh ОПИСАНИЕ
Объединённый двоичный файл (crunched binary) — это программа, состоящая из многих других программ, скомпонованных вместе в один исполняемый файл.
Функция
.Fn main
объединённого двоичного файла определяет, какую компонентную программу запускать, по содержимому
.Va argv[0] .
Основная причина объединения программ вместе — разместить
как можно больше программ на установочном или аварийно-восстановительном гибком диске.
.Pp
Утилита
.Nm
читает спецификации из
.Ar файла-конфигурации
для объединённого двоичного файла и генерирует
.Pa Makefile
и сопровождающий его
главный C-файл, которые при сборке создают объединённый исполняемый
файл из компонентных программ.
Для каждой компонентной программы
.Nm
может дополнительно попытаться определить объектные (.o) файлы, из которых состоит
программа, из
.Pa Makefile
в её исходном каталоге.
Эта информация кэшируется между запусками.
Утилита
.Nm
использует вспомогательную программу
.Xr crunchide 1
для устранения конфликтов на этапе компоновки между компонентными программами путём
скрытия всех ненужных символов.
.Pp
Утилита
.Nm
предъявляет определённые требования к
.Pa Makefile Nsам
пакетов, что делает её непригодной для использования с
.No не- Ns Bx
исходниками.
В частности,
.Pa Makefile
должен содержать цель
.Ic depend ,
и он должен определять все объектные файлы в переменной
.Va OBJS .
В некоторых случаях можно использовать фиктивный
.Pa Makefile :
перед поиском
.Pa Makefile
в исходном каталоге
.Pa foo ,
.Nm
ищет файл
.Pa Makefile.foo
в текущем каталоге.
.Pp
После запуска
.Nm
объединённый двоичный файл может быть собран запуском
.Dq Li make -f <имя-конфигурации>.mk .
Объектные файлы компонентных программ должны быть уже собраны.
Цель
.Ic objs ,
включённая в выходной makefile, будет
запускать
.Xr make 1
в исходном каталоге каждой компонентной программы, чтобы собрать объектные
файлы для пользователя.
Это не делается автоматически, так как в условиях
релиз-инжиниринга обычно нежелательно изменять объекты в других каталогах.
.Pp
Параметры следующие:
.Bl -tag -width indent
.It Fl c Ar имя-c-файла
Установить имя выходного C-файла в
.Ar имя-c-файла .
Имя по умолчанию —
.Pa <имя-конфигурации>.c .
.It Fl e Ar имя-исполняемого-файла
Установить имя исполняемого файла объединённого двоичного файла в
.Ar имя-исполняемого-файла .
Имя по умолчанию —
.Pa <имя-конфигурации> .
.It Fl f
Очистить кэш.
Принудительно пересчитывает кэшированные параметры.
.It Fl l
Вывести имена.
Выводит имена, на которые будет реагировать этот двоичный файл.
.It Fl h Ar имя-заголовка-makefile
Установить имя файла, который будет включён в начало
.Pa Makefile Nsов ,
генерируемых
.Nm .
Это полезно для определения некоторых переменных make, которые могут влиять на поведение
.Xr make 1
и которые неудобно передавать через переменные окружения.
.It Fl m Ar имя-makefile
Установить имя выходного
.Pa Makefile
в
.Ar имя-makefile .
Имя по умолчанию —
.Pa <имя-конфигурации>.mk .
.It Fl o
Добавить правила
.Dq Li make obj
к каждой цели make программы.
.It Fl p Ar префикс-объектов
Установить путь, который будет добавлен в начало
.Ic srcdir
при вычислении
.Ic objdir .
Если этот параметр не указан, то используется префикс
из содержимого переменной окружения
.Ev MAKEOBJDIRPREFIX
или
.Pa /usr/obj .
.It Fl q
Тихий режим работы.
Сообщения о состоянии подавляются.
.El
.Sh КОМАНДЫ ФАЙЛА КОНФИГУРАЦИИ CRUNCHGEN
Утилита
.Nm
читает спецификации из
.Ar файла-конфигурации ,
которые описывают компоненты объединённого двоичного файла.
В простейшем использовании
просто перечисляются имена компонентных программ и главные исходные каталоги,
в которых могут находиться их исходники.
Затем утилита
.Nm
вычисляет (через исходные make-файлы) и кэширует
список объектных файлов и их расположение.
Для более специализированных
ситуаций пользователь может вручную указать все параметры, которые
нужны
.Nm .
.Pp
Команды
.Ar файла-конфигурации
следующие:
.Bl -tag -width indent
.It Ic srcdirs Ar имя-каталога ...
Список исходных деревьев, в которых могут находиться исходные каталоги
компонентных программ.
Эти каталоги ищутся по
.Bx
соглашению
.Dq Pa <исходный-каталог>/<имя-программы>/
.
Можно указать несколько строк
.Ic srcdirs .
Каталоги ищутся в том порядке, в котором они указаны.
.It Ic progs Ar имя-программы ...
Список программ, из которых состоит объединённый двоичный файл.
Можно указать несколько строк
.Ic progs .
.It Ic libs Ar спецификация-библиотеки ...
Список спецификаций библиотек, которые должны быть включены в компоновку объединённого двоичного файла.
Можно указать несколько строк
.Ic libs .
.It Ic libs_so Ar спецификация-библиотеки ...
Список спецификаций библиотек, которые должны быть динамически скомпонованы в
объединённом двоичном файле.
Эти библиотеки должны быть доступны через редактор динамических связей времени выполнения
.Xr rtld 1
при запуске компонентной программы, которая в них нуждается, из
объединённого двоичного файла.
Можно указать несколько строк
.Ic libs_so .
Директива
.Ic libs_so
переопределяет библиотеку, указанную избыточно в строке
.Ic libs .
.It Ic buildopts Ar параметры-сборки ...
Список параметров сборки, которые нужно добавить к каждой цели make.
.It Ic ln Ar имя-программы имя-ссылки
Приводит к тому, что объединённый двоичный файл вызывает
.Ar имя-программы
всякий раз, когда
.Ar имя-ссылки
появляется в
.Va argv[0] .
Это позволяет корректно работать программам, которые меняют своё поведение при
запуске под разными именами.
.El
.Pp
Для обработки специализированных ситуаций, например, когда исходники
недоступны или сборка выполняется не через стандартный
.Pa Makefile ,
можно использовать следующие
.Ic special
команды для установки
параметров
.Nm
для компонентной программы.
.Bl -tag -width indent
.It Ic special Ar имя-программы Ic srcdir Ar путь
Установить исходный каталог для
.Ar имя-программы .
Обычно вычисляется путём поиска в указанных
.Ic srcdirs
каталога с именем
.Ar имя-программы .
.It Ic special Ar имя-программы Ic objdir Ar путь
Установить
.Pa obj
каталог для
.Ar имя-программы .
Каталог
.Pa obj
обычно вычисляется путём поиска каталога
имя которого совпадает с именем исходного каталога, к которому добавлен
один из следующих компонентов, в порядке приоритета:
аргумент
.Fl p
, переданный в командной строке; или,
значение переменной окружения
.Ev MAKEOBJDIRPREFIX
, или
.Pa /usr/obj .
Если каталог не найден, сам
.Ic srcdir
становится
.Ic objdir .
.It Ic special Ar имя-программы Ic buildopts Ar параметры-сборки
Определить набор параметров сборки, которые должны быть добавлены к
целям
.Xr make 1
в дополнение к указанным с помощью
.Ic buildopts
при обработке
.Ar имя-программы .
.It Ic special Ar имя-программы Ic objs Ar имя-объектного-файла ...
Установить список объектных файлов для программы
.Ar имя-программы .
Обычно вычисляется путём создания временного make-файла, который включает
.Dq Ic srcdir Ns / Ns Pa Makefile
и выводит значение
.Va $(OBJS) .
.It Ic special Ar имя-программы Ic objpaths Ar полный-путь-к-объектному-файлу ...
Установить пути к объектным файлам для программы
.Ar имя-программы .
Обычно вычисляется путём добавления пути
.Ic objdir
к каждому файлу в списке
.Ic objs .
.It Ic special Ar имя-программы Ic objvar Ar имя_переменной
Установить имя переменной
.Xr make 1 ,
которая содержит список
объектных файлов для программы
.Ar имя-программы .
Обычно это
.Va OBJS ,
но некоторые
.Pa Makefile Nsы
могут использовать другие соглашения или
добавлять имя программы к переменной, например,
.Va SSHD_OBJS .
.It Ic special Ar имя-программы Ic lib Ar имя-библиотеки ...
Указывает библиотеки, которые должны быть скомпонованы с объектными файлами для создания
.Ar имя-программы Ns Pa .lo .
Это может быть полезно с библиотеками, которые переопределяют процедуры в
стандартных библиотеках, или с плохо написанными библиотеками, которые
ссылаются на символы в объектных файлах.
.It Ic special Ar имя-программы Ic keep Ar имя-символа ...
Добавить указанный список символов в список исключений (keep list) для программы
.Ar имя-программы .
Подчёркивание
.Pq Ql _
добавляется к каждому символу, и он становится аргументом
параметра
.Fl k
для фазы работы
.Xr crunchide 1 .
Эту опцию следует использовать в крайнем случае, так как её использование может вызвать
конфликт символов, однако в некоторых случаях это может быть единственным способом
разрешить символ.
.It Ic special Ar имя-программы Ic ident Ar идентификатор
Установить
.Pa Makefile Ns / Ns Tn C
идентификатор для
.Ar имя-программы .
Обычно генерируется из
.Ar имя-программы ,
преобразуя
.Ql -
в
.Ql _
и игнорируя все остальные символы, не являющиеся допустимыми для идентификаторов.
Это приводит к тому, что программы с именами
.Qq Li foo.bar
и
.Qq Li foobar
отображаются на один и тот же идентификатор.
.El
.Pp
Параметр
.Ic objpaths
— единственный, который фактически нужен
.Nm ,
но он вычисляется из
.Ic objdir
и
.Ic objs ,
которые, в свою очередь, вычисляются из
.Ic srcdir ,
поэтому иногда удобно указать более ранние параметры и позволить
.Nm
вычислить остальные, если это возможно.
.Pp
Make-файл, созданный
.Nm ,
содержит необязательную цель
.Ic objs ,
которая соберёт объектные файлы для каждой компонентной программы путём
запуска
.Xr make 1
внутри исходного каталога этой программы.
Для работы этого механизма параметры
.Ic srcdir
и
.Ic objs
также должны быть корректными.
Если они некорректны для конкретной программы, эта
программа пропускается в цели
.Ic objs .
.Sh ПРИМЕРЫ
Вот пример
входного конфигурационного файла
.Nm
с именем
.Dq Pa kcopy.conf :
.Bd -literal -offset indent
srcdirs /usr/src/bin /usr/src/sbin

progs test cp echo sh fsck halt init mount umount myinstall
progs anotherprog
ln test [       # test можно вызвать через [

special myprog objpaths /homes/leroy/src/myinstall.o # исходников нет

special anotherprog -DNO_FOO WITHOUT_BAR=YES

libs -lutil -lcrypt
.Ed
.Pp
Этот конфигурационный файл определяет небольшой объединённый двоичный файл, состоящий из некоторых
базовых системных утилит, а также самостоятельно написанной программы установки
.Dq Pa myinstall ,
для которой не указан исходный каталог, но её объектный файл
указан напрямую с помощью строки
.Ic special .
.Pp
Кроме того, при сборке
.Dq Pa anotherprog
аргументы
.Pp
.Dl -DNO_FOO WITHOUT_BAR=YES
.Pp
добавляются ко всем целям сборки.
.Pp
Объединённый двоичный файл
.Dq Pa kcopy
может быть собран следующим образом:
.Bd -literal -offset indent
% crunchgen -m Makefile kcopy.conf    # сгенерировать Makefile и kcopy.c
% make objs             # собрать .o файлы компонентных программ
% make                  # собрать объединённый двоичный файл kcopy
% kcopy sh              # проверить, что это запускает оболочку sh
$			# работает!
.Ed
.Pp
На этом этапе двоичный файл
.Dq Pa kcopy
может быть скопирован на установочный гибкий диск
и жёстко связан (hard-linked) с именами компонентных программ.
.Pp
Обратите внимание, что если использовалась команда
.Ic libs_so ,
копии указанных библиотек
также необходимо будет скопировать на установочный гибкий диск.
.Sh СМ. ТАКЖЕ
.Xr crunchide 1 ,
.Xr make 1 ,
.Xr rtld 1
.Sh АВТОРЫ
.An -nosplit
Утилиту
.Nm
написал
.An James da Silva Aq Mt jds@cs.umd.edu .
.Pp
Copyright (c) 1994 Университет Мэриленда.
Все права защищены.
.Pp
Ключевое слово
.Ic libs_so
было добавлено в 2005 году
.An Adrian Steinmann Aq Mt ast@marabu.ch
и
.An Ceri Davies Aq Mt ceri@FreeBSD.org .
.Sh ПРЕДОСТЕРЕЖЕНИЯ
Хотя
.Nm
заботится об устранении конфликтов компоновки между компонентными программами
объединённого двоичного файла, конфликты всё ещё возможны между
библиотеками, которые компонуются.
Может потребоваться изменение порядка
библиотек, а в некоторых редких случаях две библиотеки могут иметь
неразрешимый конфликт и, следовательно, не могут быть объединены вместе.
.Pp
Некоторые версии среды сборки
.Bx
по умолчанию не собирают
промежуточные объектные файлы для программ с одним исходным файлом.
Затем необходимо использовать
.Dq Li make objs
для сборки этих объектных файлов или
предпринять другие меры.
