.\"	$NetBSD: m4.1,v 1.23 2012/04/08 22:00:39 wiz Exp $
.\"	@(#) $OpenBSD: m4.1,v 1.64 2017/06/15 13:48:42 bcallah Exp $
.\"
.\" Copyright (c) 1989, 1993
.\"	The Regents of the University of California.  All rights reserved.
.\"
.\" This code is derived from software contributed to Berkeley by
.\" Ozan Yigit at York University.
.\"
.\" Redistribution and use in source and binary forms, with or without
.\" modification, are permitted provided that the following conditions
.\" are met:
.\" 1. Redistributions of source code must retain the above copyright
.\"    notice, this list of conditions and the following disclaimer.
.\" 2. Redistributions in binary form must reproduce the above copyright
.\"    notice, this list of conditions and the following disclaimer in the
.\"    documentation and/or other materials provided with the distribution.
.\" 3. Neither the name of the University nor the names of its contributors
.\"    may be used to endorse or promote products derived from this software
.\"    without specific prior written permission.
.\"
.\" THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
.\" ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
.\" IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
.\" ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
.\" FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
.\" DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
.\" OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
.\" HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
.\" LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
.\" OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
.\" SUCH DAMAGE.
.\"
.\" FRDP path ./usr.bin/m4/m4.1
.\" FRDP githash bdcbfde31e8e9b343f113a1956384bdf30d1ed62
.\" FRDP hash256 bf9977ead1381078b0ab392ff0add48e4a502625541f121da1d0e28352d386e3
.Dd 21 июня, 2023
.Dt M4 1
.Os
.Sh ИМЯ
.Nm m4
.Nd процессор макроязыка
.Sh СИНТАКСИС
.Nm
.Op Fl EGgPs
.Oo
.Sm off
.Fl D Ar имя Op No = Ar значение
.Sm on
.Oc
.Op Fl d Oo Oo +- Oc Ns Ar флаги Oc
.Op Fl I Ar каталог
.Op Fl o Ar имя_файла
.Op Fl t Ar макрос
.Op Fl U Ns Ar имя
.Op Ar
.Sh ОПИСАНИЕ
Утилита
.Nm
является макропроцессором, который может использоваться как интерфейс для любого
языка (например, C, ratfor, fortran, lex и yacc).
Если входные файлы не заданы,
.Nm
читает со стандартного ввода,
иначе файлы, указанные в командной строке, обрабатываются
в заданном порядке.
Входными файлами могут быть обычные файлы, файлы в путях включения m4 или
одиночный дефис
.Pq Sq - ,
обозначающий стандартный ввод.
.Nm
записывает обработанный текст на стандартный вывод, если не указано иное.
.Pp
Вызовы макросов имеют форму имя(аргумент1[, аргумент2, ..., аргументN]).
.Pp
Не может быть пробела после имени макроса и открывающей
скобки
.Pq Sq \&( .
Если после имени макроса не следует открывающая
скобка, он обрабатывается без аргументов.
.Pp
Имена макросов состоят из начального алфавитного символа или подчёркивания,
за которым могут следовать буквенно-цифровые символы или подчёркивания, т.е.,
допустимые имена макросов соответствуют шаблону
.Dq [a-zA-Z_][a-zA-Z0-9_]* .
.Pp
В аргументах макросов ведущие непомещённые в кавычки пробелы, табуляции и символы новой строки
.Pq Sq \en
игнорируются.
Для заключения строк в кавычки используйте левую и правую одинарные кавычки
.Pq например, Sq \ \&это строка с ведущим пробелом .
Вы можете изменить символы кавычек с помощью встроенного макроса
.Ic changequote .
.Pp
Большинство встроенных макросов не имеют смысла без аргументов и поэтому не
распознаются как специальные, если за ними не следует открывающая скобка.
.Pp
Параметры следующие:
.Bl -tag -width Ds
.It Fl D Ns Ar имя Ns Oo = Ns Ar значение Oc , Fl -define Ns = Ns Ar имя Ns Oo = Ns Ar значение Oc
Определить символ
.Ar имя
как имеющий некоторое значение (или
.Dv NULL ) .
.It Fl d Oo Oo +|- Oc Ns Ar флаги Oc , Fl -debug Ns = Ns Oo Oo +|- Oc Ns Ar флаги Oc
Установить или снять флаги трассировки.
Флаги трассировки следующие:
.Bl -tag -width Ds
.It Ar a
выводить аргументы макросов.
.It Ar c
выводить раскрытие макроса на нескольких строках.
.It Ar e
выводить результат раскрытия макроса.
.It Ar f
выводить местоположение имени файла.
.It Ar l
выводить номер строки.
.It Ar q
заключать аргументы и результат раскрытия в текущие кавычки.
.It Ar t
начинать с трассировки всех макросов.
.It Ar x
нумеровать раскрытия макросов.
.It Ar V
включить все опции.
.El
.Pp
Если используется
.Qq +
или
.Qq - ,
указанные флаги добавляются к набору активных флагов трассировки или
удаляются из него соответственно; в противном случае указанные флаги
заменяют набор активных флагов трассировки.
.Pp
Указание этого параметра без аргумента эквивалентно его указанию
с аргументом
.Qq aeq .
.Pp
По умолчанию трассировка установлена в
.Qq eq .
.It Fl E , Fl -fatal-warnings
Сделать предупреждения фатальными.
Когда указан один флаг
.Fl E ,
если выданы предупреждения, выполнение
продолжается, но
.Nm
завершится с ненулевым статусом выхода.
Когда указано несколько флагов
.Fl E ,
выполнение остановится при выдаче первого
предупреждения, и
.Nm
завершится с ненулевым статусом выхода.
Это поведение соответствует GNU m4 1.4.9 и позднее.
.It Fl G , Fl -traditional
Отключить режим совместимости с GNU (см.
.Fl g
ниже).
.It Fl g , Fl -gnu
Включить режим совместимости с GNU.
В этом режиме
.Ic translit
обрабатывает простые диапазоны символов (например,
.Sq a-z ) ,
регулярные выражения имитируют поведение Emacs,
множественные вызовы
.Ic m4wrap
обрабатываются как стек,
количество диверсий неограниченно,
допускаются пустые имена для определений макросов,
.Ic undivert
можно использовать для включения файлов, и
.Ic eval
понимает числа в формате
.Sq 0rоснование:значение .
.It Fl I Ar каталог , Fl -include Ns = Ns Ar каталог
Добавить каталог
.Ar каталог
в путь включения.
.It Fl o Ar имя_файла , Fl -error-output Ns = Ns Ar имя_файла
Отправлять вывод трассировки в
.Ar имя_файла .
.It Fl P , Fl -prefix-builtins
Добавить префикс ко всем встроенным макросам:
.Sq m4_ .
Например, вместо записи
.Ic define
используйте
.Ic m4_define .
.It Fl s , Fl -synclines
Выводить директивы синхронизации строк, подходящие для
.Xr cpp 1 .
.It Fl t Ar макрос , Fl -trace Ns = Ns Ar макрос
Включить трассировку для
.Ar макрос .
.It Fl U Ns Ar имя , Fl -undefine Ns = Ns Ar имя
Удалить определение символа
.Ar имя .
.El
.Sh СИНТАКСИС
.Nm
предоставляет следующие встроенные макросы.
Они могут быть переопределены, что приведёт к потере их исходного значения.
Возвращаемые значения равны null, если не указано иное.
.Bl -tag -width changequote
.It Fn builtin имя
Вызывает встроенный макрос по его
.Fa имени ,
обходя возможные переопределения.
.It Fn changecom начало_комментария конец_комментария
Изменяет последовательности начала и конца комментария.
Последовательности комментариев могут быть длиной до пяти символов.
Значения по умолчанию — знак решётки
и символ новой строки.
.Bd -literal -offset indent
# Это комментарий
.Ed
.Pp
Без аргументов комментарии отключаются.
С одним аргументом последовательность конца комментария устанавливается
в символ новой строки.
.It Fn changequote начало_кавычки конец_кавычки
Определяет последовательности открывающих и закрывающих кавычек.
Последовательности кавычек могут быть длиной до пяти символов.
Значения по умолчанию — символ обратной кавычки и символ
кавычки.
.Bd -literal -offset indent
`Вот строка в кавычках'
.Ed
.Pp
Без аргументов восстанавливаются кавычки по умолчанию.
С одним аргументом последовательность закрывающих кавычек устанавливается
в символ новой строки.
.It Fn decr аргумент
Уменьшает аргумент
.Fa аргумент
на 1.
Аргумент
.Fa аргумент
должен быть допустимой числовой строкой.
.It Fn define имя значение
Определить новый макрос с именем, заданным первым аргументом
.Fa имя ,
чтобы иметь
значение второго аргумента
.Fa значение .
Каждое вхождение
.Sq $n
(где
.Ar n
от 0 до 9) заменяется на
.Ar n Ns -ый
аргумент.
.Sq $0
— это имя вызывающего макроса.
Неопределённые аргументы заменяются пустой строкой.
.Sq $#
заменяется на количество аргументов;
.Sq $*
заменяется на все аргументы, разделённые запятыми;
.Sq $@
такой же, как
.Sq $* ,
но все аргументы взяты в кавычки для защиты от дальнейшего раскрытия.
.It Fn defn имя ...
Возвращает взятое в кавычки определение для каждого аргумента.
Это можно использовать для переименования
определений макросов (даже встроенных).
.It Fn divert номер
Существует 10 очередей вывода (пронумерованных 0-9).
В конце обработки
.Nm
объединяет все очереди в числовом порядке для получения
итогового вывода.
Изначально очередь вывода — 0.
Макрос divert
позволяет выбрать новую очередь вывода (недопустимый аргумент,
переданный в divert, приводит к отбрасыванию вывода).
.It Ic divnum
Возвращает номер текущей очереди вывода.
.It Ic dnl
Отбрасывает входные символы до следующего символа новой строки включительно.
.It Fn dumpdef имя ...
Печатает имена и определения для указанных элементов или для всего,
если аргументы не переданы.
.It Fn errprint сообщение
Печатает первый аргумент в стандартный поток ошибок.
.It Fn esyscmd команда
Передаёт свой первый аргумент оболочке и возвращает стандартный вывод оболочки.
Обратите внимание, что оболочка разделяет свой стандартный ввод и стандартный вывод ошибок с
.Nm .
.It Fn eval выражение[,основание[,минимум]]
Вычисляет первый аргумент как арифметическое выражение с использованием 32-битной
арифметики.
Операторы — стандартные тернарные, арифметические, логические,
сдвиговые, реляционные, побитовые операторы C и скобки.
Можно указывать
восьмеричные, десятичные и шестнадцатеричные числа, как в C.
Необязательный второй аргумент
.Fa основание
задаёт основание системы счисления для результата, а необязательный третий аргумент
.Fa минимум
задаёт минимальное количество цифр в результате.
.It Fn expr выражение
Это псевдоним для
.Ic eval .
.It Fn format строка_формата аргумент1 ...
Возвращает
.Fa строка_формата
с escape-последовательностями, заменёнными на
.Fa аргумент1
и последующие аргументы, способом, подобным
.Xr printf 3 .
Эта встроенная функция доступна только в режиме совместимости с GNU-m4, и единственные
реализованные параметры предназначены для совместимости с autoconf:
флаг заполнения слева, необязательная ширина поля, максимальная ширина поля,
ширины полей, заданные через *, и тип данных %s и %c.
.It Fn ifdef имя да нет
Если макрос с именем, заданным первым аргументом, определён, то возвращает второй
аргумент, иначе третий.
Если третьего аргумента нет, значение равно
.Dv NULL .
Слово
.Qq unix
предопределено.
.It Fn ifelse a b да ...
Если первый аргумент
.Fa a
совпадает со вторым аргументом
.Fa b ,
то
.Fn ifelse
возвращает
третий аргумент
.Fa да .
Если совпадение не удаётся, три аргумента
отбрасываются, и используются следующие три аргумента, пока не останется
ноль или один аргумент; возвращается либо этот последний аргумент, либо
.Dv NULL ,
если других совпадений не найдено.
.It Fn include имя
Возвращает содержимое файла, указанного в первом аргументе.
Если файл не найден как есть, поиск осуществляется по пути включения:
сначала в каталогах, указанных с помощью
.Fl I
в командной строке, затем в переменной окружения
.Ev M4PATH ,
как в списке каталогов, разделённых двоеточиями.
Include завершается с сообщением об ошибке, если файл не может быть включён.
.It Fn incr аргумент
Увеличивает аргумент на 1.
Аргумент должен быть допустимой числовой строкой.
.It Fn index строка подстрока
Возвращает индекс второго аргумента в первом аргументе (например,
.Ic index(быстрая коричневая лиса прыгнула, лиса)
возвращает 16).
Если второй
аргумент не найден, index возвращает \-1.
.It Fn indir макрос аргумент1 ...
Косвенно вызывает макрос, чьё имя передано как первый аргумент,
с оставшимися аргументами, переданными как первый, ... аргументы.
.It Fn len аргумент
Возвращает количество символов в первом аргументе.
Дополнительные аргументы
игнорируются.
.It Fn m4exit код
Немедленно завершает работу с возвращаемым значением, указанным первым аргументом,
или 0, если он не указан.
.It Fn m4wrap задача
Позволяет определить, что происходит при окончательном
.Dv EOF ,
обычно для целей очистки (например,
вызывает макрос очистки
после завершения всей остальной обработки).
.Pp
Множественные вызовы
.Fn m4wrap
вставляются последовательно при окончательном
.Dv EOF .
.It Fn maketemp шаблон
Как
.Ic mkstemp .
.It Fn mkstemp шаблон
Вызывает
.Xr mkstemp 3
на первом аргументе и возвращает изменённую строку.
Это можно использовать для создания уникальных
имён временных файлов.
.It Fn paste файл
Включает содержимое файла, указанного первым аргументом, без
какой-либо обработки макросов.
Завершается с сообщением об ошибке, если файл не может быть
включён.
.It Fn patsubst строка регулярное_выражение замена
Заменяет регулярное выражение в строке строкой замены.
Применяются обычные шаблоны замены: амперсанд
.Pq Sq \&&
заменяется строкой, соответствующей регулярному выражению.
Строка
.Sq \e# ,
где
.Sq #
— цифра, заменяется соответствующей обратной ссылкой.
.It Fn popdef аргумент ...
Восстанавливает
.Ic pushdef Ns ированное
определение для каждого аргумента.
.It Fn pushdef макрос определение
Принимает те же аргументы, что и
.Ic define ,
но сохраняет определение в
стеке для последующего извлечения с помощью
.Fn popdef .
.It Fn regexp строка регулярное_выражение замена
Находит регулярное выражение в строке.
Если дополнительные аргументы не даны,
возвращает позицию первого совпадения или \-1, если совпадений нет.
Если задан третий аргумент,
возвращает строку замены с заменёнными подшаблонами.
.It Fn shift аргумент1 ...
Возвращает все аргументы, кроме первого; оставшиеся аргументы
берутся в кавычки и возвращаются обратно с запятыми между ними.
Заключение в кавычки
нейтрализует эффект дополнительного сканирования, которое будет впоследствии
выполнено.
.It Fn sinclude файл
Аналогично
.Ic include ,
но игнорирует любые ошибки.
.It Fn spaste файл
Аналогично
.Fn paste ,
но игнорирует любые ошибки.
.It Fn substr строка смещение длина
Возвращает подстроку первого аргумента, начиная со смещения, указанного
вторым аргументом, и длиной, указанной третьим аргументом.
Если третий аргумент отсутствует, возвращает остаток строки.
.It Fn syscmd команда
Передаёт первый аргумент оболочке.
Ничего не возвращает.
.It Ic sysval
Возвращает значение возврата из последнего
.Ic syscmd .
.It Fn traceon аргумент ...
Включает трассировку раскрытия макросов для заданных аргументов или для всех
макросов, если аргумент не задан.
.It Fn traceoff аргумент ...
Отключает трассировку раскрытия макросов для заданных аргументов или для всех
макросов, если аргумент не задан.
.It Fn translit строка набор_откуда набор_куда
Транслитерирует символы в первом аргументе из набора,
заданного вторым аргументом, в набор, заданный третьим.
Нельзя использовать
сокращения в стиле
.Xr tr 1 .
.It Fn undefine имя1 ...
Удаляет определение для макросов, указанных в аргументах.
.It Fn undivert аргумент ...
Сбрасывает именованные очереди вывода (или все очереди, если аргументов нет).
.It Ic unix
Предопределённый макрос для тестирования платформы ОС.
.It Ic __line__
Возвращает номер текущей строки файла.
.It Ic __file__
Возвращает имя текущего файла.
.El
.Sh СТАТУС ВЫХОДА
.Ex -std m4
.Pp
Но обратите внимание, что макрос
.Ic m4exit
может изменить статус выхода, как и флаг
.Fl E .
.Sh СМ. ТАКЖЕ
.Rs
.%A B. W. Керниган
.%A D. M. Ричи
.%I AT&T Bell Laboratories
.%T Макропроцессор M4
.%R Отчёт по техническим вопросам вычислительной науки
.%N 59
.%D июль 1977
.Re
.Sh СТАНДАРТЫ
Утилита
.Nm
соответствует спецификации
.St -p1003.1-2008 .
.Pp
Флаги
.Op Fl dEGgIPot
и макросы
.Ic builtin ,
.Ic esyscmd ,
.Ic expr ,
.Ic format ,
.Ic indir ,
.Ic paste ,
.Ic patsubst ,
.Ic regexp ,
.Ic spaste ,
.Ic unix ,
.Ic __line__ ,
и
.Ic __file__
являются расширениями к этой спецификации.
.Pp
.Ic maketemp
не должен быть синонимом для
.Ic mkstemp ,
а вместо этого быть функцией создания небезопасных имён временных файлов.
Он помечен в
.St -p1003.1-2008
как устаревший, и его не следует использовать, если важна переносимость.
.Pp
Формат вывода
.Ic traceon
и
.Ic dumpdef
не указан ни в одном стандарте,
вероятно, изменится и на него не стоит полагаться.
Текущий формат трассировки тесно смоделирован на
.Nm gnu-m4 ,
чтобы позволить работать
.Nm autoconf .
.Pp
Встроенные макросы
.Ic pushdef
и
.Ic popdef
обрабатывают определения макросов как стек.
Однако,
.Ic define
взаимодействует со стеком неопределённым образом.
В этой реализации
.Ic define
заменяет только верхнее определение.
Другие реализации могут стирать все определения в стеке.
.Pp
Во многих других
.Nm
все встроенные макросы раскрываются без аргументов.
.Pp
Многие другие
.Nm
имеют серьёзные ограничения по размеру буферов.
.Sh АВТОРЫ
.An -nosplit
.An Ozan Yigit Aq Mt oz@sis.yorku.ca
и
.An Richard A. O'Keefe Aq Mt ok@goanna.cs.rmit.OZ.AU .
.Pp
Расширения для совместимости с GNU-m4 от
.An Marc Espie Aq Mt espie@cvs.openbsd.org .
